#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include "myFunc.h"


int main() {
    int j;
    int fifoIn = mkfifo("FIFO_IN", 0666);
    int PID = 0;
    if (fifoIn == -1) {
        printf("Error during the creation of the FIFO, end of the task.");
        exit(-1);
    }
    int fifInOpen = open("FIFO_IN", O_RDWR);
    if (fifInOpen == -1) {
        printf("FIFO_IN can't be open, end of the task.");
        exit(-2);

    }
    while (true){
    int fifoInRead = read(fifInOpen, &PID, sizeof(int));
    if (fifoInRead != sizeof(int)) {
        printf("Error during the reading of the FIFO, end of the task.");
        exit(-3);
    }
    printf("%d", PID);
    int fOpen = open("ATIS.txt", O_RDWR);
    if (fOpen == -1) {
        printf("Error during the opening of ATIS, end of the task.");
        exit(-5);

    }
    char atis[500];
    int verification = open("lock.txt", RDONLY);
    while (verification != -1) {
        verification = open("lock.txt", RDONLY);
    }
    int atisRead = read(fOpen, &atis, sizeof(atis));
    if (atisRead == -1) {
        printf("Error during the reading of atis, end of the task.");
        exit(-6);
        }
    close(fOpen);

    char* fifoPilName = concatenation(PID);
    int fifoPilOpen = open(fifoPilName, O_RDWR);
    if (fifoPilOpen == -1) {
        printf("Error during the opening of the FIFO PIL, end of the task.");
        exit(-7);
    }
    int fifoPilWrite = write(fifoPilOpen, atis, sizeof(atis));
    if (fifoPilWrite == -1 ) {
        printf("Error during the writing of ATIS in FIFO PIL, end of the task.");
        exit(-8);
    }
    Sleep(2);
    char confirmation[2];
    int fifoPilRead = read(fifoPilote, &confirmation, sizeof(confirmation));
    if (fifoPilRead != sizeof(confirmation)) {
        printf("Error during the reading of FIFO PIL, end of the task.");
        exit(-9);
    }
    while (strcmp(confirmation, "KO") == 0) {
        fifoPilWrite = write(fifoPilOpen, atis, sizeof(atis));
        if (fifoPilWrite == -1 ) {
            printf("Error during the writing of ATIS in FIFO PIL, end of the task.");
            exit(-10);
        }
        Sleep(2);
        fifoPilRead = read(fifoPilote, &confirmation, sizeof(confirmation));
        if (fifoPilRead != sizeof(confirmation)) {
            printf("Error during the reading of FIFO PIL, end of the task.");
            exit(-11);
        }
    }
    close(fifoPilOpen);
    unlink(fifoPilName);
    }
    close(fifInOpen);
    unlink("FIFO_IN");
    return 0;

}
